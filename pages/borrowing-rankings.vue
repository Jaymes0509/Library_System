<template>
  <div ref="topContainer" class="p-8 w-full">
    <h1 class="text-3xl font-bold mb-6 text-center">圖書排行榜</h1>

    <!-- 排行分類選單 -->
    <div v-if="step === 'summary'" class="flex justify-center gap-10 mb-8">
      <button
        v-for="option in sortOptions"
        :key="option.value"
        @click="step = option.value"
        class="text-lg font-medium text-gray-700 hover:text-blue-600 hover:underline"
      >
        {{ option.label }}
      </button>
    </div>

    <!-- 總覽排行榜（三卡片） -->
    <div v-if="step === 'summary'" class="grid grid-cols-1 md:grid-cols-3 gap-6 justify-items-center mb-12">
      <div
        v-for="type in ['reserve', 'borrow', 'rating']"
        :key="type"
        class="bg-white rounded-xl shadow p-6 max-w-[380px] w-full"
      >
        <h2 class="text-xl font-bold border-b pb-2 mb-4">
          {{
            type === 'reserve' ? '預約次數排行榜(總和)' :
            type === 'borrow' ? '借閱次數排行榜(總和)' :
            '評分高低排行榜(總和)'
          }}
        </h2>
        <ol class="space-y-4">
          <li
            v-for="(book, index) in topBooks(type, true)"
            :key="book.book_id + '-' + type"
            class="flex gap-4 items-center border-b pb-2"
          >
            <div class="text-center w-12">
              <div class="text-lg font-bold text-red-600">NO.{{ index + 1 }}</div>
            </div>
            <img :src="book.cover || defaultCover" alt="封面" class="w-14 h-20 object-cover rounded border shadow" />
            <div class="flex-1">
              <div class="font-semibold">{{ book.title }}</div>
              <div class="text-sm text-gray-600">作者：{{ book.author }}</div>
              <div class="text-sm mt-1">
                {{
                  type === 'reserve' ? '預約次數：' :
                  type === 'borrow' ? '借閱次數：' :
                  '平均評分：'
                }}
                <span class="font-bold">
                  {{ type === 'rating' ? book.stat_count.toFixed(1) : book.stat_count }}
                </span>
              </div>
            </div>
          </li>
        </ol>
      </div>
    </div>

    <!-- 詳細排行榜畫面（第二層） -->
    <div v-else class="bg-white p-8 rounded-xl shadow w-full">
      <h2 class="text-3xl font-bold mb-6 text-center">
        {{
          step === 'borrow' ? '📘 借閱排行榜詳細' :
          step === 'reserve' ? '📗 預約排行榜詳細' :
          '📙 評分排行榜詳細'
        }}
      </h2>

      <!-- 查詢篩選區塊 -->
      <div class="grid md:grid-cols-2 gap-4 mb-6">
  <div>
    <!-- 書籍分類在上 -->
    <label class="block font-medium mb-1">書籍分類：</label>
    <select v-model="selectedCategory" class="border rounded px-2 py-1 w-full mb-4">
      <option value="">全部分類</option>
      <option v-for="cat in bookCategories" :key="cat" :value="cat">{{ cat }}</option>
    </select>

    <!-- 時間篩選在下 -->
    <label class="block font-medium mb-1">時間篩選：</label>
    <div class="flex gap-2">
      <select v-model="selectedPeriod" class="border rounded px-2 py-1 w-full">
        <option value="all">總和</option>
        <option value="year">年份</option>
        <option value="month">月份</option>
      </select>
      <select v-if="selectedPeriod === 'year'" v-model="selectedYear" class="border rounded px-2 py-1 w-32">
        <option v-for="year in years" :key="year" :value="year">{{ year }}</option>
      </select>
      <select v-if="selectedPeriod === 'month'" v-model="selectedMonth" class="border rounded px-2 py-1 w-32">
        <option v-for="month in months" :key="month" :value="month">{{ month }} 月</option>
      </select>
    </div>
  </div>

  <div class="flex items-end justify-end">
    <button @click="step = 'summary'" class="text-sm text-blue-500 hover:underline">
      ← 返回排行榜總覽
    </button>
  </div>
</div>


      <!-- 書籍清單 -->
      <ol class="space-y-6">
        <li v-for="(book, index) in topBooks(step)" :key="book.book_id"
          class="flex items-center gap-6 border-b pb-6 bg-white rounded shadow px-4 py-6">
          <div class="text-center min-w-[50px]">
            <div class="text-3xl font-bold text-red-600">{{ index + 1 }}</div>
          </div>
          <img :src="book.cover || defaultCover" class="w-32 h-44 object-cover rounded border shadow" />
          <div class="flex-1">
            <div class="text-xl font-bold text-black mb-2">{{ book.title }}</div>
            <div class="text-sm text-gray-700 mb-2">作者：{{ book.author }}</div>
            <div class="text-sm text-gray-600" style="line-height: 1.6">
              {{
                step === 'borrow' ? '借閱次數：' :
                step === 'reserve' ? '預約次數：' :
                '平均評分：'
              }}
              <span class="font-bold">
                {{ step === 'rating' ? book.stat_count.toFixed(1) : book.stat_count }}
              </span>
            </div>
          </div>
        </li>
      </ol>

      <!-- 分頁與每頁顯示設定 -->
      <div class="flex flex-wrap justify-between items-center mt-8">
        <div>
          每頁顯示：
          <select v-model="pageSize" class="border px-2 py-1 rounded">
            <option v-for="size in [10, 20, 50, 100]" :key="size" :value="size">{{ size }}</option>
          </select> 本
        </div>
        <div class="flex flex-wrap gap-1">
          <button v-for="page in totalPages" :key="page" @click="currentPage = page"
            :class="['px-3 py-1 border rounded', currentPage === page ? 'bg-blue-500 text-white' : 'bg-white']">
            {{ page }}
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue'

const step = ref('summary')
const defaultCover = 'https://via.placeholder.com/80x120.png?text=No+Cover'

const sortOptions = [
  { label: '預約次數', value: 'reserve' },
  { label: '借閱次數', value: 'borrow' },
  { label: '評分高低', value: 'rating' }
]

const selectedPeriod = ref('all')
const selectedCategory = ref('')
const selectedYear = ref(new Date().getFullYear())
const selectedMonth = ref(new Date().getMonth() + 1)
const currentPage = ref(1)
const pageSize = ref(10)

const bookCategories = [
  '哲學類', '宗教類', '科學類', '應用科學類', '社會科學類',
  '語文類', '藝術類', '歷史類', '地理類', '文學類', '總類', '其他'
]

const years = [2023, 2024, 2025]
const months = Array.from({ length: 12 }, (_, i) => i + 1)

const rankedBooks = ref([
  { book_id: 1, title: '解憂雜貨店', author: '東野圭吾', stat_count: 25, cover: '', period: 'all', category: '文學類' , type: 'reserve'},
  { book_id: 2, title: '追風箏的人', author: '卡勒德·胡賽尼', stat_count: 22, cover: '', period: 'year', category: '文學類' , type: 'reserve'},
  { book_id: 3, title: '白夜行', author: '東野圭吾', stat_count: 19, cover: '', period: 'month', category: '文學類' , type: 'reserve'},
  { book_id: 4, title: '活著', author: '余華', stat_count: 18, cover: '', period: 'year', category: '文學類' , type: 'reserve'},
  { book_id: 5, title: '小王子', author: '安東尼·聖修伯里', stat_count: 17, cover: '', period: 'all', category: '文學類', type: 'reserve' },
  { book_id: 6, title: '百年孤寂', author: '馬奎斯', stat_count: 16, cover: '', period: 'month', category: '文學類' , type: 'reserve'},
  { book_id: 7, title: '擺渡人', author: '克萊兒·麥克福爾', stat_count: 15, cover: '', period: 'all', category: '文學類' , type: 'reserve'},
  { book_id: 8, title: '你當像鳥飛往你的山', author: '塔拉・魏斯特弗', stat_count: 14, cover: '', period: 'year', category: '歷史類', type: 'reserve' },
  { book_id: 9, title: '三體', author: '劉慈欣', stat_count: 13, cover: '', period: 'month', category: '科學類' , type: 'reserve'},
  { book_id: 10, title: '房思琪的初戀樂園', author: '林奕含', stat_count: 12, cover: '', period: 'all', category: '文學類', type: 'reserve' }
])

function topBooks(type, isSummary = false) {
  const filtered = rankedBooks.value.filter(book => {
    const periodMatch = selectedPeriod.value === 'all' || book.period === selectedPeriod.value
    const categoryMatch = !selectedCategory.value || book.category === selectedCategory.value
    const typeMatch = isSummary || step.value === type
    return periodMatch && categoryMatch && typeMatch
  }).sort((a, b) => b.stat_count - a.stat_count)

  const start = (currentPage.value - 1) * pageSize.value
  return filtered.slice(start, start + pageSize.value)
}

const totalPages = computed(() => {
  const filtered = rankedBooks.value.filter(book => {
    const periodMatch = selectedPeriod.value === 'all' || book.period === selectedPeriod.value
    const categoryMatch = !selectedCategory.value || book.category === selectedCategory.value
    return periodMatch && categoryMatch
  })
  return Math.ceil(filtered.length / pageSize.value) || 1
})

watch([selectedPeriod, selectedCategory], () => {
  currentPage.value = 1
})
</script>
